<!DOCTYPE html>
<html lang="eng-us">

<!--  test.html to test the API for showtimes


-->


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Date Night</title>
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">  -->

    <!-- load in a reset of CSS  -->
    <!-- *RPB  redo the styles after loading in the rest.css  -->
    <!-- <link rel="stylesheet" type="text/css" href="assets/css/reset.css">   -->
    <!-- load my style sheet -->
    <!-- JQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!--
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  -->

    <!-- Bootstrap CDN-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="assets/javascript/moment.js"></script>
    <script src="assets/javascript/numeral.js"></script>

</head>

<body>
    <div>
        <hr>
    </div>
    <div>
        <hr>
    </div>
    <div class="wrapper">
        <div id="inputSect" style="margin:3px; padding:3px">
            <!--        <form id="user-form">   -->
            <label for="number-input">Latitude</label>
            <input type="number" id="input-lat">
            <p></p>
            <label for="number-input">Longitude</label>
            <input type="number" id="input-lon">
            <p></p>
            <label for="number-input">Distance</label>
            <input type="number" id="input-dist">
            <p></p>
            <!-- Button triggers new movie to be added -->
            <input id="bttnUserInput" type="submit" value="Submit">
            <!--        </form>   -->
        </div>
    </div>
    <div>
        <hr>
    </div>
    <div class="wrapper">
        <div class="container-fluid">
            <div id="movieOutput" style="margin:3px; padding:5px"></div>
        </div>
    </div>
    <!-- Modal windows come up next -->
    <!-- GPS Modal -->
    <div id="modLocation" class="modal">
        <div class="modal-content">
            <span id="closeModLocation" class="close">&times;</span>
            <h2>
                <p>Searching for GPS location</p>
            </h2>
            <p> </p>
            <p>Please allow location privaledge and then wait</p>
        </div>
    </div>
    <!-- Searching for all movie entries Modal -->
    <div id="modSearch1" class="modal">
        <div class="modal-content">
            <span id="closeModSearch1" class="close">&times;</span>
            <h2>
                <p>Searching for all theaters and movies within search area</p>
            </h2>
            <p> </p>
            <p>Please wait ...</p>
        </div>
    </div>
    <!-- Searching for all movie entries Modal -->
    <div id="modSearch2" class="modal">
        <div class="modal-content">
            <span id="closeModSearch2" class="close">&times;</span>
            <h2>
                <p>Searching for all movie data </p>
            </h2>
            <p> </p>
            <p>Please wait ...</p>
        </div>
    </div>
    <!-- Searching for cinema address Modal -->
    <div id="modSearch3" class="modal">
        <div class="modal-content">
            <span id="closeModSearch3" class="close">&times;</span>
            <h2>
                <p>Searching for addresses </p>
            </h2>
            <p> </p>
            <p>Please wait ...</p>
        </div>
    </div>


    <script>
        var configData = {
            theaterSearchDist: 2, //2 miles search earea
            restaurantSearchDist: 2, //2 miles

        };


        var modalWaitSearch1 = document.getElementById('modSearch1'); //earch all records
        var modalWaitSearch2 = document.getElementById('modSearch2'); //search movies
        var modalWaitSearch3 = document.getElementById('modSearch3'); //search cinemas
        var modalWaitLocation = document.getElementById('modLocation'); //location



        var dataSrch = "";
        var dataSrchDone = false;
        var dataTheaterSearch;

        var theaterRecType = {  //this is record type coming from iShowTimes
            auditorium: "",
            booking_type: "",
            cinema_id: "",
            is_3d: false,
            movie_id: "",
            start_at: "",      //time to start 
            EOR: ""            //place marker
        };


        var movieRecType = {  //this is what is stored for each movie
            title: "",
            rating: "",
            runtime: "",
            imdb_id: "", // incase want to search other web sites
            thumbImgUrl: "",    //thumbnail sized image files
            genres: [],
            synopsis: "",
            movie_id: "",
            urlWebsite: "",
            urlTrailer: "",
            closestDist: 0
        };

        var theaterFoundType = {  //this is for every theater that was found
            cinema_id: "",      //id to link to name of theater
            theaterName: "",   //actual name of the theater
            address: {
                dispText: "",
                houseNum: "",
                street: "",
                city: "",
                state: "",
                zipCode: "",
                geoLocLat: 0,
                geoLocLong: 0,
                distToCenter: 0
            }
        };

        var theaterObj = {   //main object for the whole theater
            currTheater: {
                theaterRec: theaterRecType,      //the current theater with movie
                theaterName: "",   //actual name of the theater
                address: {
                    dispText: "",
                    houseNum: "",
                    street: "",
                    city: "",
                    state: "",
                    zipCode: "",
                    geoLocLat: 0,
                    geoLocLong: 0,
                    distToCenter: 0
                },
                url: "",
                telephone: "",
                movie: {
                    title: "",
                    rating: "",
                    runtime: "",
                    imdb_id: "", // in case want to search other web sites
                    thumbImgUrl: "",    //thumbnail sized image files
                    genres: []
                },
                EOR: ""    //place keeper, no comma needed
            },

            currMovieRec: movieRecType,

            currTheaterFound: theaterFoundType,

            searchParam: {
                //everything that stays fixed for search parameters
                urlPart1: "https://api.internationalshowtimes.com/v4/",
                qryCinemas: "cinemas/",
                qryMovies: "movies/",
                urlShowTimes: "showtimes/",    //for showtimes
                qryTimeFrom: "&time_from=",
                qryTimeTo: "&time_to=",
                urlLimit: "&limit=1",          //when searching for one item
                urlQryKey: "?apikey=xeeFzVhhznvw4MuwL9eZOxR0QhEdUZQW",  //API key
                urlCountry: "&countries=US",   //country
                urlBoundGeo: "&bounds=(42.056552,-87.707449),(42.040462,-87.670348)",  //geoposition bounds
                qryGeoLocation: "&location=",  //then put in lat,lon with comma between them
                qryDistance: "&distance=",     //in kilometers
                EOR: ""
            },

            //variables are here
            theaterStack: [],      //array of theaters  --- treat as stack
            theatersFoundStack: [],  //all the theaters found
            cinemaIDstack: [],     //to look up unique cinema ID's
            numCinemaConv: 0,       //which cinema ID converting
            numSearchConv: 0,      //storage for the loop going thru the conversion
            searchLat: "",
            searchLon: "",
            searchDist: "",     //in kilometers
            movieIDvals: [],    //all the movie ID's
            movieStack: [],     //array of movieRecType, sorted by movie name
            genresStack: [],   //all the genres found


            buildSearchStr: function (typeSearch, indexNum) {
                var timeFromStr = "2018-02-18T00:00:00-08:00";
                var timeToStr = "2018-02-19T00:00:00-08:00";
                var outString = "";
                var SP = this.searchParam;
                var formatStr = "YYYY-MM-DD h:mm:ss";
                //timeFromStr = moment().format(formatStr);
                timeFromStr = moment().utc().format();
                timeToStr = moment().add(12, "hours").utc().format();
                if (typeSearch == 1) {
                    outString = SP.urlPart1 + SP.urlShowTimes + SP.urlQryKey + SP.qryGeoLocation + theaterObj.searchLat + "," + theaterObj.searchLon + SP.qryDistance + theaterObj.searchDist;
                    //outString = SP.urlPart1 + SP.urlShowTimes + SP.urlQryKey + SP.urlCountry + SP.urlBoundGeo;
                    outString += SP.qryTimeFrom + timeFromStr + SP.qryTimeTo + timeToStr;
                    console.log(outString);
                };
                if (typeSearch == 2) {
                    var cinemaID = theaterObj.cinemaIDstack[indexNum]; //pull from unique cinemaID's
                    outString = SP.urlPart1 + SP.qryCinemas + cinemaID + SP.urlQryKey;
                    console.log(outString);
                };
                if (typeSearch == 3) {
                    var movieID = theaterObj.movieIDvals[indexNum];
                    if (movieID === "" || movieID === null) {
                        //null movieID
                        outString = "";
                    } else {
                        outString = SP.urlPart1 + SP.qryMovies + movieID + SP.urlQryKey + SP.urlLimit;
                    }
                    console.log(outString);
                };

                return outString;
            },


            doSearchInitial: function () {
                //function to do current search
                //return the response    
                //typeSearch = 1 is the closest theaters

                dataSrchDone = false;
                var shouldSearch = true;
                //stop from multiple searches
                var urlString = this.buildSearchStr(1, 0);
                //check if it is a null string, if so, then need to take care of
                if (urlString === "") { shouldSearch = false; };
                if (shouldSearch) {
                    jQuery.ajax({
                        url: urlString,
                        type: "GET"
                    })
                        .done(function (dataSrch, textStatus, jqXHR) {
                            console.log("HTTP Request Succeeded: " + jqXHR.status);
                            //console.log(dataSrch);
                            dataTheaterSearch = jQuery.extend(true, {}, dataSrch);
                            theaterObj.doSearchInitialDone();
                            //return dataTheaterSearch;
                        })
                        .fail(function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus);
                            console.log(errorThrown);
                            console.log("HTTP Request Failed");
                        })
                        .always(function () {
                            /* ... */
                        });
                } else {
                    //mimic a search was finished
                    theaterObj.doSearchInitialDone();
                };
            },


            doSearchInitialDone: function () {
                //part one of search is done
                theaterObj.theaterResponseToStack(dataTheaterSearch);
                console.log("... done ....");
                //all of the theater records are in
                //need to now get all the movie Id
                var tStack = theaterObj.theaterStack;
                var numRecs = tStack.length;
                theaterObj.clearMovieIDvals();
                theaterObj.clearMovieStack();
                //clear out the genres stack
                for (var i = 0; i < theaterObj.genresStack.length; i++) {
                    theaterObj.genresStack.pop();
                };

                //push the first one
                theaterObj.movieIDvals.push(tStack[0].theaterRec.movie_id);
                //loop thru and load single occurance of each movie ID
                for (var i = 0; i < numRecs; i++) {
                    if (tStack[i].theaterRec.movie_id == null) {
                        //sometimes searches come back with nothing
                        console.log("null at " + i);
                    } else {
                        //loop thru all and add single movie_id's to array to search later
                        if (theaterObj.movieIDvals.indexOf(tStack[i].theaterRec.movie_id) < 0) {
                            //the movie id has not been used
                            theaterObj.movieIDvals.push(tStack[i].theaterRec.movie_id);
                        };
                    };
                };

                modalWaitSearch1.style.display = "none";
                modalWaitSearch2.style.display = "block";
                //now have to search the movie id's
                theaterObj.numSearchConv = 0;
                theaterObj.doMovieSearch(theaterObj.numSearchConv);
            },


            doMovieSearch: function (indexNum) {
                //function to do movie id search to get name of movie

                dataSrchDone = false;
                var shouldSearch = true;
                //stop from multiple searches
                var movieID = theaterObj.movieIDvals[indexNum];
                theaterObj.currMovieRec.movie_id = movieID;
                console.log("searching movie: " + indexNum + " id=" + movieID);

                var urlString = this.buildSearchStr(3, indexNum);
                //check if it is a null string, if so, then need to take care of
                if (urlString === "") { shouldSearch = false; };
                if (shouldSearch) {
                    jQuery.ajax({
                        url: urlString,
                        type: "GET"
                    })
                        .done(function (dataSrch, textStatus, jqXHR) {
                            console.log("HTTP Request Succeeded: " + jqXHR.status);
                            console.log(dataSrch);
                            dataTheaterSearch = jQuery.extend(true, {}, dataSrch);
                            dataSrchDone = true;
                            theaterObj.doMovieSearchDone(indexNum);
                        })
                        .fail(function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus);
                            console.log(errorThrown);
                            console.log("HTTP Request Failed");
                        })
                        .always(function () {
                            /* ... */
                        });
                } else {
                    //mimic a search was finished
                    theaterObj.doMovieSearchDone(indexNum);
                };
            },


            doMovieSearchDone: function (indexNum) {
                //searching on movie names
                var mRec = theaterObj.currMovieRec;
                if (dataTheaterSearch.movie.title == null || dataTheaterSearch.movie.title === "") {
                    //title is blank, then user original title
                    mRec.title = dataTheaterSearch.movie.original_title;
                } else {
                    mRec.title = dataTheaterSearch.movie.title;
                };
                if (dataTheaterSearch.movie.age_limits != null) {
                    mRec.rating = dataTheaterSearch.movie.age_limits.US;
                } else {
                    mRec.rating = "none";
                };
                mRec.urlWebsite = dataTheaterSearch.movie.website;
                //now only move the trailer if it exists
                if (dataTheaterSearch.movie.trailers != null) {
                    //there are trailers
                    //load the first trailer and then replace if there are english
                    mRec.urlTrailer = dataTheaterSearch.movie.trailers[0].trailer_files[0].url;
                    var numTrailers = dataTheaterSearch.movie.trailers.length;
                    for (var i = 0; i < numTrailers; i++) {
                        if (dataTheaterSearch.movie.trailers.language === "en-US") {
                            //use the English trailer
                            mRec.urlTrailer = dataTheaterSearch.movie.trailers[i].trailer_files[0].url;
                        } else if (dataTheaterSearch.movie.trailers.language === "en") {
                            mRec.urlTrailer = dataTheaterSearch.movie.trailers[i].trailer_files[0].url;
                        };
                    };
                };
                if (dataTheaterSearch.movie.trailers != null) {
                    mRec.synopsis = dataTheaterSearch.movie.synopsis;
                } else {
                    mRec.synopsis = "";
                }
                mRec.runtime = dataTheaterSearch.movie.runtime;
                mRec.imdb_id = dataTheaterSearch.movie.imdb_id;
                mRec.thumbImgUrl = dataTheaterSearch.movie.poster_image.image_files[0].url;
                //mRec.movie_id = dataTheaterSearch.theaterRec.movie_id;

                //clear all current genres
                var currAmount = mRec.genres.length;
                for (var i = 0; i < currAmount; i++) {
                    mRec.genres.pop();
                };

                var genStack = theaterObj.genresStack;  //use as shortcut
                var endVal = dataTheaterSearch.movie.genres.length;
                for (var i = 0; i < endVal; i++) {
                    //loop thru and add in all the genres for the film
                    mRec.genres.push(dataTheaterSearch.movie.genres[i].name);
                    //after adding for the movie, add into stack and make sure
                    //it is a unique entry
                    if (genStack.length === 0) {
                        //no entries so push in the first one
                        genStack.push(dataTheaterSearch.movie.genres[i].name);
                    } else {
                        if (genStack.indexOf(dataTheaterSearch.movie.genres[i].name) < 0) {
                            //no match in current stack, so insert it
                            genStack.push(dataTheaterSearch.movie.genres[i].name);
                        };
                    };
                };

                //can not just add to the stack, need to put in alpha order
                theaterObj.addToMovieStack();
                //var newObj = jQuery.extend(true, {}, mRec);
                //theaterObj.movieStack.push(newObj);    //object is now on the stack


                theaterObj.numSearchConv++; //go to the next one
                //check if all the movie ID's have been searched
                if (theaterObj.numSearchConv < theaterObj.movieIDvals.length) {
                    //do another search
                    theaterObj.doMovieSearch(theaterObj.numSearchConv);
                } else {
                    modalWaitSearch2.style.display = "none";
                    modalWaitSearch3.style.display = "block";
                    theaterObj.numCinemaConv = 0;
                    //clear out the theatersFound stack
                    for (var k = 0; k < theaterObj.theatersFoundStack.length; k++) {
                        theaterObj.theatersFoundStack.pop();
                    };
                    console.log("theaters found stack ");
                    console.log(theaterObj.theatersFoundStack);
                    theaterObj.doCinemaSearch(theaterObj.numCinemaConv);
                };
            },


            doCinemaSearch: function (indexNum) {
                //function to go thru cinema ID's and get the addresses 

                dataSrchDone = false;
                var shouldSearch = true;
                //stop from multiple searches
                //check if should search
                var cinemaID = theaterObj.cinemaIDstack[indexNum];
                var urlString = this.buildSearchStr(2, indexNum);
                //check if it is a null string, if so, then need to take care of
                if (urlString === "") { shouldSearch = false; };
                if (shouldSearch) {
                    jQuery.ajax({
                        url: urlString,
                        type: "GET"
                    })
                        .done(function (dataSrch, textStatus, jqXHR) {
                            console.log("HTTP Request Succeeded: " + jqXHR.status);
                            console.log(dataSrch);
                            dataTheaterSearch = jQuery.extend(true, {}, dataSrch);
                            dataSrchDone = true;
                            theaterObj.doCinemaSearchDone(indexNum);
                            //return dataTheaterSearch;
                        })
                        .fail(function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus);
                            console.log(errorThrown);
                            console.log("HTTP Request Failed");
                        })
                        .always(function () {
                            /* ... */
                        });
                } else {
                    //mimic a search was finished
                    theaterObj.doCinemaSearchDone(indexNum);
                };
            },


            doCinemaSearchDone: function (indexNum) {
                //part one of search is done, now need movie theater names
                var ctfRec = theaterObj.currTheaterFound;  //for shorthand notation
                ctfRec.cinema_id = theaterObj.cinemaIDstack[indexNum];
                ctfRec.theaterName = dataTheaterSearch.cinema.name;
                ctfRec.address.geoLocLat = dataTheaterSearch.cinema.location.lat;
                ctfRec.address.geoLocLong = dataTheaterSearch.cinema.location.lon;
                ctfRec.address.dispText = dataTheaterSearch.cinema.location.address.display_text;
                ctfRec.address.houseNum = dataTheaterSearch.cinema.location.address.house;
                ctfRec.address.street = dataTheaterSearch.cinema.location.address.street;
                ctfRec.address.city = dataTheaterSearch.cinema.location.address.city;
                ctfRec.address.state = dataTheaterSearch.cinema.location.address.state_abbr;
                ctfRec.address.zipCode = dataTheaterSearch.cinema.location.address.zipcode;
                ctfRec.url = dataTheaterSearch.cinema.website;
                ctfRec.telephone = dataTheaterSearch.cinema.telephone;
                ctfRec.distToCenter = 0;

                var newRec = jQuery.extend(true, {}, ctfRec);
                theaterObj.theatersFoundStack.push(newRec);
                console.log("converting .. " + theaterObj.numCinemaConv);
                theaterObj.numCinemaConv++; //go to the next one
                if (theaterObj.numCinemaConv < theaterObj.cinemaIDstack.length) {
                    //do another search
                    theaterObj.doCinemaSearch(theaterObj.numCinemaConv);
                } else {
                    theaterObj.numCinemaConv = 0;
                    modalWaitSearch3.style.display = "none";
                    outputMovies();
                    outputTheaters();
                    //theaterObj.doSearch(3, theaterObj.numSearchConv);
                };
            },

            clearStack: function () {
                //clears all the current values in the array
                var endVal = theaterObj.theaterStack.length;
                for (var i = 0; i < endVal; i++) {
                    theaterObj.theaterStack.pop();
                };
            },

            pushToStack: function () {
                //takes the currTheater and treats as record and pushes to stack array
                //have to make a copy of an object before pushing it anywhere
                var newObj = jQuery.extend(true, {}, theaterObj.currTheater);
                theaterObj.theaterStack.push(newObj);    //object is now on the stack
            },

            theaterResponseToStack: function (responseIn) {
                //pass the response in, just in case doing external to object
                //this is parsing for iShowTimes
                //stack is NOT CLEARED prior to entering
                var stArray = responseIn.showtimes;  //showtimes array shortcut
                console.log("response in");
                console.log(stArray);

                var currTheaterRec = theaterObj.currTheater.theaterRec; //shortcut
                var endVal = stArray.length;
                for (var i = 0; i < endVal; i++) {
                    //transfer the theater response to the currRec variable
                    currTheaterRec.auditorium = stArray[i].auditorium;
                    currTheaterRec.booking_type = stArray[i].booking_type;
                    currTheaterRec.cinema_id = stArray[i].cinema_id;
                    currTheaterRec.is_3d = stArray[i].is_3d;
                    currTheaterRec.movie_id = stArray[i].movie_id;
                    currTheaterRec.start_at = stArray[i].start_at;
                    theaterObj.pushToStack();  //make permanent
                    //add it to unique theater list
                    if (theaterObj.cinemaIDstack.length === 0) {
                        //var theaterFoundRec = Object.create(theaterFoundType);
                        //theaterFoundRec.cinema_id = stArray[i].cinema_id;
                        //theaterObj.theatersFoundStack.push(theaterFoundRec);
                        theaterObj.cinemaIDstack.push(currTheaterRec.cinema_id); //unique ID lookup list
                    } else {
                        //there is more than one entry, so make sure it is unique
                        if (theaterObj.cinemaIDstack.indexOf(currTheaterRec.cinema_id) < 0) {
                            //this is a new cinema not on the stack 
                            //var theaterFoundRec = Object.create(theaterFoundType);
                            //theaterFoundRec.cinema_id = stArray[i].cinema_id;
                            //theaterObj.theatersFoundStack.push(theaterFoundRec);
                            theaterObj.cinemaIDstack.push(currTheaterRec.cinema_id); //unique ID lookup list
                        };
                    };
                };
            },


            clearMovieIDvals: function () {
                var endVal = theaterObj.movieIDvals.length;
                for (var i = 0; i < endVal; i++) {
                    theaterObj.movieIDvals.pop();
                }
            },

            clearMovieStack: function () {
                //clears all the current values in the array
                var endVal = theaterObj.movieStack.length;
                for (var i = 0; i < endVal; i++) {
                    theaterObj.movieStack.pop();
                };
            },

            addToMovieStack: function () {
                //takes the currMovie and treats as record and pushes to stack array
                //puts in alpahbetical order onto the movie stack
                //have to make a copy of an object before pushing it anywhere
                if (theaterObj.movieStack.length === 0) {
                    //no records on the stack so push the first one
                    var newObj = jQuery.extend(true, {}, theaterObj.currMovieRec);
                    theaterObj.movieStack.push(newObj);    //object is now on the stack
                } else {
                    var endVal = theaterObj.movieStack.length;
                    var i = 0;  //loop iterator
                    //shortened variable names
                    var mRec = theaterObj.currMovieRec;
                    var mStack = theaterObj.movieStack;
                    var loopContinue = true;
                    do {
                        console.log("i=" + i);
                        if (mRec.title.toUpperCase() > mStack[i].title.toUpperCase()) {
                            if (i === (endVal - 1)) {
                                //at the end of the loop, so push at end
                                var newObj = jQuery.extend(true, {}, mRec);
                                mStack.push(newObj);    //object is now on the stack                                
                                loopContinue = false;
                            } else {
                                //it is greater than, so keep moving
                                i++;
                                loopContinue = true;
                            };
                        } else {
                            //it is less then check if it is the first one 
                            if (i === 0) {
                                var newObj = jQuery.extend(true, {}, mRec);
                                mStack.unshift(newObj);    //adds to begining of stack                                
                                loopContinue = false;
                            } else {
                                //splice into the middle of the array
                                var newObj = jQuery.extend(true, {}, mRec);
                                mStack.splice(i, 0, newObj);
                                loopContinue = false;
                            };
                        };

                    } while (loopContinue);
                };
            },

            EOR: ""    //place keeper so don't have to worry about stupid commas
        };

        var testSearch = function () {
            theaterObj.clearStack();
            modalWaitSearch1.style.display = "block";

            //clear all the movie theaters found in the area
            for (var i = 0; i < theaterObj.theatersFoundStack.length; i++) {
                theaterObj.theatersFoundStack.pop();
            };
            //clear all the movie theaters found in the area
            for (var i = 0; i < theaterObj.cinemaIDstack.length; i++) {
                theaterObj.cinemaIDstack.pop();
            };

            theaterObj.doSearchInitial();
            console.log("data search done = " + dataSrchDone);
            console.log("waiting for a return");
        };


        var outputMovies = function () {
            //outputs search to movies
            var divOutput = $("#movieOutput");
            divOutput.html("");
            var mStack = theaterObj.movieStack;
            var numFound = mStack.length;

            //findings heading
            var newRow = $("<div>");
            $(newRow).addClass("row");
            var newPtag = $("<p>");
            var H3tag = $("<h3>");
            var findingsStr = "What was found:";
            $(H3tag).text(findingsStr);
            $(H3tag).appendTo(newPtag);
            $(newPtag).appendTo(newRow);

            var H4tag = $("<h4>");
            findingsStr = "Num of movies = " + numFound;
            findingsStr += " in " + theaterObj.cinemaIDstack.length + " theaters.";
            $(H4tag).text(findingsStr);
            $(H4tag).appendTo(newPtag);
            H4tag = $("<h4>");
            findingsStr = "Num of genres = " + theaterObj.genresStack.length;
            $(H4tag).text(findingsStr);
            $(H4tag).appendTo(newPtag);

            theaterObj.genresStack.sort();
            newPtag = $("<p>");
            //$(newPtag).text("Genres found and sorted:");
            //$(newPtag).appendTo(newRow);
            var genresFoundStr = "";
            for (var i = 0; i < theaterObj.genresStack.length; i++) {
                genresFoundStr += theaterObj.genresStack[i] + " , ";
            };
            //newPtag = $("<p>");
            $(newPtag).text(genresFoundStr);
            $(newPtag).appendTo(newRow);

            $(newRow).appendTo(divOutput);


            for (var i = 0; i < numFound; i++) {
                //loop thru the entire stack
                //var stackPtr = th[i];

                var newRow = $("<div>");
                $(newRow).addClass("row");
                var movieStr = mStack[i].title;
                var rating = mStack[i].rating;
                var runTime = mStack.runtime + " min";

                var H2tag = $("<h4>");
                var line1str = movieStr;
                var newPtag = $("<p>");

                $(H2tag).text(line1str);
                $(H2tag).appendTo(newPtag);
                $(newPtag).appendTo(newRow);

                var line2str = "";
                newPtag = $("<p>");
                $(newPtag).text(line2str);
                $(newPtag).appendTo(newRow);

                var urlMovieThumb = mStack[i].thumbImgUrl;
                var imgTag = $("<img>");
                $(imgTag).attr("src", urlMovieThumb)
                $(imgTag).appendTo(newRow);
                //$(newRow).appendTo(divOutput);

                //put rating to page
                newPtag = $("<p>");
                $(newPtag).text("rating: " + mStack[i].rating);
                $(newPtag).appendTo(newRow);

                //put to page the genres for this movie
                var lineGenres = "";
                var currAmount = mStack[i].genres.length;
                for (var k = 0; k < currAmount; k++) {
                    lineGenres += mStack[i].genres[k] + " , ";
                };
                newPtag = $("<p>");
                $(newPtag).text(lineGenres);
                $(newPtag).appendTo(newRow);

                newPtag = $("<p>");
                HRtag = $("<hr>");
                $(HRtag).appendTo(newPtag);
                $(newPtag).appendTo(newRow);
                $(newRow).appendTo(divOutput);
            };
            newRow = $("<div>");
            $(newRow).addClass("row");
            newPtag = $("<p>");
            HRtag = $("<hr>");
            $(HRtag).appendTo(newPtag);
            $(newPtag).appendTo(newRow);        //hor row
            $(newPtag).appendTo(newRow);        //2nd hor row


            //finish out the row
            $(newRow).appendTo(divOutput);

        };


        var outputTheaters = function () {
            //outputs search to movies
            var divOutput = $("#movieOutput");
            //divOutput.html("");
            var tfStack = theaterObj.theatersFoundStack;
            var numFound = tfStack.length;

            //findings heading
            var newRow = $("<div>");
            $(newRow).addClass("row");
            $(newRow).css("line-height", "2px");
            $(newRow).css("margin", "2px");
            $(newRow).css("padding", "2px");
            $(newRow).addClass("row");

            var newPtag = $("<p>");
            var H3tag = $("<h3>");
            var findingsStr = "Theaters found in search area";
            $(H3tag).text(findingsStr);
            $(H3tag).appendTo(newPtag);
            $(newPtag).appendTo(newRow);    
            //$(newRow).appendTo(divOutput);

            //var newRow = $("<div>");

            for (var i = 0; i < numFound; i++) {
                //loop thru the entire stack of theaters found

                //bring out as local variable for demo purposes
                var nameStr = tfStack[i].theaterName;
                var address = tfStack[i].address.houseNum + " " + tfStack[i].address.street;
                var city = tfStack[i].address.city;
                var state = tfStack[i].address.state;
                var zipcode = tfStack[i].address.zipCode;
                var geoLat = tfStack[i].address.geoLocLat;
                var geoLong = tfStack[i].address.geoLocLong;
                var distToCenter = tfStack[i].address.distToCenter;


                var H3tag = $("<h4>");
                $(H3tag).css("line-height", "1.0");
                $(H3tag).css("margin", "0px");
                $(H3tag).css("padding", "0px");
                var line1str = nameStr;
                var newPtag = $("<p>");
                $(newPtag).css("margin", "0px");
                $(newPtag).css("padding", "0px");
                $(newPtag).css("line-height", "2px");

                $(H3tag).text(line1str);
                $(H3tag).appendTo(newPtag);
                var brTag = $("<br/>");
                $(brTag).appendTo(newPtag);

                var H4tag = $("<h5>");
                $(H4tag).css("line-height", "1.0");
                $(H4tag).css("margin", "0px");
                $(H4tag).css("padding", "0px");
                var line2str = address;
                $(H4tag).text(line2str);
                $(H4tag).appendTo(newPtag);
                var brTag = $("<br/>");
                $(brTag).appendTo(newPtag);

                H4tag = $("<h5>");
                $(H4tag).css("line-height", "1.0");
                $(H4tag).css("margin", "0px");
                $(H4tag).css("padding", "0px");
                var line3str = city + " , " + state + " " + zipcode;
                $(H4tag).text(line3str);
                $(H4tag).appendTo(newPtag);
                var brTag = $("<br/>");
                $(brTag).css("line-height", "2px");
                $(brTag).appendTo(newPtag);

                H4tag = $("<h5>");
                $(H4tag).css("line-height", "1.0");
                $(H4tag).css("margin", "0px");
                $(H4tag).css("padding", "0px");
                var line4str = "Geo loc: (" + geoLat + " , " + geoLong + " )";
                $(H4tag).text(line4str);
                $(H4tag).appendTo(newPtag);
                var brTag = $("<br/>");
                $(brTag).css("line-height", "2px");
                $(brTag).appendTo(newPtag);

                H4tag = $("<h5>");
                $(H4tag).css("line-height", "1.0");
                $(H4tag).css("margin", "0px");
                $(H4tag).css("padding", "0px");
                var line5str = "Distance away: " + distToCenter;
                $(H4tag).text(line5str);
                $(H4tag).appendTo(newPtag);
                var brTag = $("<br/>");
                $(brTag).appendTo(newPtag);
                $(newPtag).appendTo(newRow);

                newPtag = $("<p>");
                $(newPtag).text(" ");
                var brTag = $("<br/>");
                $(brTag).appendTo(newPtag);
                $(newPtag).appendTo(newRow);
            };

            $(newRow).appendTo(divOutput);
            newRow = $("<div>");
            $(newRow).addClass("row");
            newPtag = $("<p>");
            HRtag = $("<hr>");
            $(HRtag).appendTo(newPtag);
            $(newPtag).appendTo(newRow);        //hor row
            $(newPtag).appendTo(newRow);        //2nd hor row

            //finish out the row
            $(newRow).appendTo(divOutput);
        };


        var outputShowTimes = function () {
            //outputs search to movies
            var divOutput = $("#movieOutput");
            divOutput.html("");
            var mStack = theaterObj.movieStack.length;
            var numFound = mStack.length;
            for (var i = 0; i < numFound; i++) {
                //loop thru the entire stack
                var stackPtr = th[i];

                var newRow = $("<div>");
                $(newRow).addClass("row");
                var movieStr = mStack[i].movie.title;
                var rating = mStack[i].movie.rating;
                //var theaterName = stack.theaterName;
                //var theaterStreet = stackPtr.address.street;
                //var theaterCity = stackPtr.address.city;
                //var theaterState = stackPtr.address.state;
                //var startTime = moment(stackPtr.theaterRec.start_at).format("h:mm a");
                var runTime = mStack.runtime + " min";
                //var stopTime = moment(stackPtr.theaterRec.start_at).add(stackPtr.movie.runtime, "minutes").format("h:mm a");

                var H2tag = $("<h3>");
                var line1str = movieStr;
                var newPtag = $("<p>");

                $(H2tag).text(line1str);
                var H3tag = $("<h4>");
                $(H3tag).text(" " + startTime + " " + "run=" + runTime + " ends = " + stopTime);
                $(H2tag).appendTo(newPtag);
                $(H3tag).appendTo(newPtag);
                $(newPtag).appendTo(newRow);

                var line2str = theaterName
                    + " " + theaterCity + "," + theaterState;
                newPtag = $("<p>");
                newPtag.text(line2str);
                $(newPtag).appendTo(newRow);
                $(newRow).appendTo(divOutput);

                var line3str = theaterStreet + " " + theaterCity + ", " + theaterState;
                newPtag = $("<p>");
                newPtag.text(line3str);
                $(newPtag).appendTo(newRow);
                $(newRow).appendTo(divOutput);

                //now the location file
                var line4str = "lat=" + stackPtr.address.geoLocLat + " lon=" + stackPtr.address.geoLocLong;
                newPtag = $("<p>");
                newPtag.text(line4str);
                $(newPtag).appendTo(newRow);
                $(newRow).appendTo(divOutput);

                var urlMovieThumb = stackPtr.movie.thumbImgUrl;
                var imgTag = $("<img>");
                $(imgTag).attr("src", urlMovieThumb)
                $(imgTag).appendTo(newRow);

                newPtag = $("<p>");
                HRtag = $("<hr>");
                $(HRtag).appendTo(newPtag);
                $(newPtag).appendTo(newRow);
                $(newRow).appendTo(divOutput);
            };
        };


        function getLocation() {
            modalWaitLocation.style.display = "block";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                //no GPS allowed
                alert("Geolocation is not supported by this browser.");
            }

        };

        function showPosition(position) {
            $("#input-lat").val(numeral(position.coords.latitude).format("0000.000000"));
            $("#input-lon").val(numeral(position.coords.longitude).format("0000.000000"));
            $("#input-dist").val(numeral(configData.theaterSearchDist).format("0.0"));
            modalWaitLocation.style.display = "none";
        };

        $(document).ready(function () {
            getLocation();

            $("#bttnUserInput").on("click", function (event) {
                //submit button was pushed
                console.log("submit clicked");
                event.preventDefault();
                theaterObj.searchLat = numeral($("#input-lat").val()).format("+0000.000000");
                theaterObj.searchLon = numeral($("#input-lon").val()).format("+0000.000000");
                var distInKM = parseFloat($("#input-dist").val()) * 1.60934;
                theaterObj.searchDist = numeral(distInKM).format("+0000.0000");

                if (theaterObj.searchLat === "+0000.000000" || theaterObj.searchLon === "+0000.000000") {
                    //left blank, so put in Evanston as default
                    theaterObj.searchLat = numeral(42.048995).format("+0000.000000");
                    theaterObj.searchLon = numeral(-87.684505).format("+0000.000000");
                    theaterObj.searchDist = numeral(6.00).format("+0000.0000");
                };

                //for modal popups

                testSearch();
            });
        });
    </script>

</body>

</html>